{{define "sidebar"}}
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h1 class="logo">Docstor</h1>
        {{if .Tenant}}
        <span class="tenant-name">{{.Tenant.Name}}</span>
        {{end}}
    </div>
    <nav class="sidebar-nav">
        <a href="/" class="nav-item" data-nav="dashboard">Dashboard</a>
        <a href="/docs" class="nav-item" data-nav="docs">Docs</a>
        <a href="/runbooks" class="nav-item" data-nav="runbooks">Runbooks</a>
        <a href="/clients" class="nav-item" data-nav="clients">Clients</a>
        <a href="/evidence-bundles" class="nav-item" data-nav="evidence-bundles">Evidence Bundles</a>
        <a href="/search" class="nav-item" data-nav="search">Search</a>
        <a href="/docs/health" class="nav-item" data-nav="doc-health">üìä Doc Health</a>
        {{if .Membership.IsAdmin}}
        <a href="/admin/users" class="nav-item" data-nav="admin">‚öôÔ∏è Admin</a>
        {{end}}
    </nav>
</aside>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
{{end}}

{{define "head_common"}}
<link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
<meta name="csrf-token" content="{{.CSRFToken}}">
{{end}}

{{define "alerts"}}
{{if .Error}}<div class="alert alert-error"><span>{{.Error}}</span><button class="alert-dismiss" aria-label="Dismiss">&times;</button></div>{{end}}
{{if .Success}}<div class="alert alert-success"><span>{{.Success}}</span><button class="alert-dismiss" aria-label="Dismiss">&times;</button></div>{{end}}
{{end}}

{{define "topbar"}}
<header class="topbar">
    <div class="topbar-left">
        <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
            <span></span><span></span><span></span>
        </button>
    </div>
    <div class="topbar-right">
        <form action="/search" method="get" class="search-form">
            <input type="search" name="q" placeholder="Search docs..." class="search-input">
        </form>
        {{if .User}}
        <div class="user-menu">
            <span class="user-info">{{.User.Name}}</span>
            <form action="/logout" method="POST" style="display: inline;">
                                {{.CSRFField}}
                <button type="submit" class="btn btn-secondary btn-sm">Logout</button>
            </form>
        </div>
        {{else}}
        <a href="/login" class="btn btn-primary btn-sm">Login</a>
        {{end}}
    </div>
</header>
{{end}}

{{define "page_scripts"}}
<script>
// HTMX CSRF token injection
document.addEventListener('htmx:configRequest', function(e) {
    var token = document.querySelector('meta[name="csrf-token"]');
    if (token) {
        e.detail.headers['X-CSRF-Token'] = token.getAttribute('content');
    }
});

// Sidebar toggle for mobile
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebar-overlay').classList.toggle('open');
}

// Active nav highlight
(function() {
    var path = window.location.pathname;
    var navItems = document.querySelectorAll('.nav-item[data-nav]');
    var best = null;
    var bestLen = 0;
    navItems.forEach(function(item) {
        var href = item.getAttribute('href');
        if (path === href || (href !== '/' && path.startsWith(href))) {
            if (href.length > bestLen) {
                best = item;
                bestLen = href.length;
            }
        }
    });
    if (!best && path === '/') {
        best = document.querySelector('.nav-item[data-nav="dashboard"]');
    }
    if (best) best.classList.add('active');
})();

// Auto-dismiss flash alerts after 5 seconds
(function() {
    document.querySelectorAll('.alert-success').forEach(function(el) {
        setTimeout(function() {
            el.style.transition = 'opacity 0.3s, max-height 0.3s, margin 0.3s, padding 0.3s';
            el.style.opacity = '0';
            el.style.maxHeight = '0';
            el.style.margin = '0';
            el.style.padding = '0';
            el.style.overflow = 'hidden';
            setTimeout(function() { el.remove(); }, 350);
        }, 5000);
    });
    // Dismiss buttons
    document.querySelectorAll('.alert-dismiss').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var alert = btn.closest('.alert');
            alert.style.transition = 'opacity 0.2s';
            alert.style.opacity = '0';
            setTimeout(function() { alert.remove(); }, 200);
        });
    });
})();

// Loading state on form submit
(function() {
    document.querySelectorAll('form').forEach(function(form) {
        // Skip search forms and inline logout
        if (form.classList.contains('search-form') || form.classList.contains('search-filters-form')) return;
        if (form.action && form.action.indexOf('/logout') !== -1) return;
        form.addEventListener('submit', function() {
            var btn = form.querySelector('button[type="submit"]');
            if (btn && !btn.classList.contains('loading')) {
                btn.classList.add('loading');
                // Delay disable so browser submits the form first
                setTimeout(function() {
                    btn.disabled = true;
                }, 50);
                // Re-enable after 8s in case of error
                setTimeout(function() {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                }, 8000);
            }
        });
    });
})();

// Confirm dialogs for destructive actions
function confirmAction(title, message, form) {
    var overlay = document.createElement('div');
    overlay.className = 'confirm-overlay';
    overlay.innerHTML =
        '<div class="confirm-dialog danger">' +
        '<h3>' + title + '</h3>' +
        '<p>' + message + '</p>' +
        '<div class="confirm-dialog-actions">' +
        '<button class="btn btn-secondary" data-action="cancel">Cancel</button>' +
        '<button class="btn btn-danger" data-action="confirm">Confirm</button>' +
        '</div></div>';
    document.body.appendChild(overlay);
    overlay.querySelector('[data-action="cancel"]').addEventListener('click', function() {
        overlay.remove();
    });
    overlay.querySelector('[data-action="confirm"]').addEventListener('click', function() {
        overlay.remove();
        form.submit();
    });
    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) overlay.remove();
    });
}

// Wire up data-confirm attributes
document.querySelectorAll('[data-confirm]').forEach(function(el) {
    el.addEventListener('click', function(e) {
        e.preventDefault();
        var form = el.closest('form');
        if (!form) return;
        e.stopPropagation();
        confirmAction(
            el.getAttribute('data-confirm-title') || 'Are you sure?',
            el.getAttribute('data-confirm'),
            form
        );
    });
});

// Relative time formatting
(function() {
    document.querySelectorAll('time[datetime]').forEach(function(el) {
        var dt = new Date(el.getAttribute('datetime'));
        var now = new Date();
        var diff = (now - dt) / 1000;
        var text;
        if (diff < 60) text = 'just now';
        else if (diff < 3600) text = Math.floor(diff/60) + 'm ago';
        else if (diff < 86400) text = Math.floor(diff/3600) + 'h ago';
        else if (diff < 604800) text = Math.floor(diff/86400) + 'd ago';
        else return; // older than a week, keep absolute
        el.setAttribute('title', el.textContent);
        el.textContent = text;
        el.classList.add('time-relative');
    });
})();

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+K or Cmd+K: focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        var input = document.querySelector('.search-input');
        if (input) input.focus();
    }
    // Ctrl+S or Cmd+S: save form (on edit pages)
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        var editForm = document.querySelector('form[action*="/save"]');
        if (editForm) {
            e.preventDefault();
            editForm.submit();
        }
    }
    // Esc: close sidebar on mobile, close confirm dialog
    if (e.key === 'Escape') {
        var overlay = document.querySelector('.confirm-overlay');
        if (overlay) { overlay.remove(); return; }
        var sidebar = document.getElementById('sidebar');
        if (sidebar && sidebar.classList.contains('open')) toggleSidebar();
    }
});

// Copy button for code blocks in rendered markdown
(function() {
    document.querySelectorAll('.markdown-body pre').forEach(function(pre) {
        var btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'Copy';
        btn.type = 'button';
        btn.addEventListener('click', function() {
            var code = pre.querySelector('code');
            var text = code ? code.textContent : pre.textContent;
            navigator.clipboard.writeText(text).then(function() {
                btn.textContent = 'Copied!';
                setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
            });
        });
        pre.style.position = 'relative';
        pre.appendChild(btn);
    });
})();
</script>
{{end}}
