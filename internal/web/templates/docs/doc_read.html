{{define "doc_read.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {{template "head_common" .}}
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>
</head>
<body>
    <div class="app-container">
        {{template "sidebar" .}}
        <main class="main-content">
            {{template "topbar" .}}
            <div class="content">
                {{template "alerts" .}}

                <nav class="breadcrumbs">
                    <a href="/docs">Docs</a>
                    <span class="separator">/</span>
                    {{.Document.Title}}
                </nav>

                <div class="doc-container">
                    <div class="doc-main">
                        <div class="page-header">
                            <div class="page-header-row">
                                <h2>{{.Document.Title}}</h2>
                                <div class="doc-actions">
                                    {{if $.Membership.IsEditor}}
                                    <a href="/docs/id/{{.Document.ID}}/edit" class="btn btn-primary">Edit</a>
                                    {{end}}
                                    <a href="/docs/id/{{.Document.ID}}/history" class="btn btn-secondary">History</a>
                                    <a href="/docs/id/{{.Document.ID}}/attachments" class="btn btn-secondary">Attachments</a>
                                    {{if $.Membership.IsEditor}}
                                    <a href="/docs/id/{{.Document.ID}}/rename" class="btn btn-secondary">Rename</a>
                                    <form action="/docs/id/{{.Document.ID}}/delete" method="POST" style="display: inline;">
                                        {{$.CSRFField}}
                                        <button type="submit" class="btn btn-danger"
                                            data-confirm="This will permanently delete this document and all its revisions. This cannot be undone."
                                            data-confirm-title="Delete Document?">Delete</button>
                                    </form>
                                    {{end}}
                                </div>
                            </div>
                            <div class="doc-meta">
                                <span class="doc-path"><code>{{.Document.Path}}</code></span>
                                {{if eq .Document.DocType "runbook"}}
                                <span class="badge badge-warning">Runbook</span>
                                {{end}}
                                {{if .Document.Client}}
                                <span class="doc-client">Client: <a href="/clients/{{.Document.Client.ID}}">{{.Document.Client.Name}}</a></span>
                                {{end}}
                            </div>
                        </div>

                        <div class="card doc-content">
                            <div class="markdown-body">
                                {{.RenderedBody}}
                            </div>
                        </div>
                    </div>

                    <aside class="doc-sidebar">
                        {{if eq .Document.DocType "runbook"}}
                        <div class="card {{if .RunbookOverdue}}card-danger{{end}}">
                            <h4>Runbook Status</h4>
                            {{if .RunbookStatus}}
                            <dl class="meta-list">
                                <dt>Status</dt>
                                <dd>
                                    {{if .RunbookOverdue}}
                                    <span class="badge badge-danger">Overdue</span>
                                    {{else if .RunbookStatus.LastVerifiedAt}}
                                    <span class="badge badge-success">Verified</span>
                                    {{else}}
                                    <span class="badge badge-warning">Not Verified</span>
                                    {{end}}
                                </dd>
                                {{if .RunbookStatus.LastVerifiedAt}}
                                <dt>Last Verified</dt>
                                <dd>{{.RunbookStatus.LastVerifiedAt.Format "Jan 2, 2006"}}</dd>
                                {{end}}
                                {{if .RunbookStatus.NextDueAt}}
                                <dt>Next Due</dt>
                                <dd class="{{if .RunbookOverdue}}text-danger{{end}}">{{.RunbookStatus.NextDueAt.Format "Jan 2, 2006"}}</dd>
                                {{end}}
                                <dt>Interval</dt>
                                <dd>{{.RunbookStatus.VerificationIntervalDays}} days</dd>
                            </dl>
                            {{if $.Membership.IsEditor}}
                            <form action="/docs/id/{{.Document.ID}}/verify" method="POST" style="margin-top: 1rem;">
                                {{.CSRFField}}
                                <button type="submit" class="btn btn-success btn-block">Mark as Verified</button>
                            </form>
                            {{end}}
                            {{else}}
                            {{if $.Membership.IsEditor}}
                            <p class="text-muted">Not yet configured for verification.</p>
                            <form action="/docs/id/{{.Document.ID}}/verify" method="POST">
                                {{.CSRFField}}
                                <button type="submit" class="btn btn-success btn-block">Start Verification Tracking</button>
                            </form>
                            {{end}}
                            {{end}}
                        </div>
                        {{end}}

                        <div class="card">
                            <h4>Document Info
                                {{if $.Membership.IsEditor}}
                                <button type="button" class="btn btn-sm btn-secondary" style="float:right; font-size: 0.75rem;" onclick="this.closest('.card').querySelector('.meta-edit-form').style.display = this.closest('.card').querySelector('.meta-edit-form').style.display === 'none' ? 'block' : 'none'; this.textContent = this.textContent === 'Edit' ? 'Cancel' : 'Edit';">Edit</button>
                                {{end}}
                            </h4>
                            <dl class="meta-list">
                                <dt>Type</dt>
                                <dd>{{if eq .Document.DocType "runbook"}}<span class="badge badge-warning">Runbook</span>{{else}}<span class="badge">Doc</span>{{end}}</dd>
                                <dt>Sensitivity</dt>
                                <dd><span class="badge">{{.Document.Sensitivity}}</span></dd>
                                <dt>Created</dt>
                                <dd>{{.Document.CreatedAt.Format "Jan 2, 2006"}}</dd>
                                <dt>Updated</dt>
                                <dd>{{.Document.UpdatedAt.Format "Jan 2, 2006 3:04 PM"}}</dd>
                                {{if .Document.Owner}}
                                <dt>Owner</dt>
                                <dd>{{.Document.Owner.Name}}</dd>
                                {{else}}
                                <dt>Owner</dt>
                                <dd><span class="text-muted">Unassigned</span></dd>
                                {{end}}
                                {{if .Document.Client}}
                                <dt>Client</dt>
                                <dd><a href="/clients/{{.Document.Client.ID}}">{{.Document.Client.Name}}</a></dd>
                                {{end}}
                                {{if .Document.CurrentRevision}}
                                {{if .Document.CurrentRevision.Author}}
                                <dt>Last edited by</dt>
                                <dd>{{.Document.CurrentRevision.Author.Name}}</dd>
                                {{end}}
                                {{end}}
                            </dl>
                            {{if $.Membership.IsEditor}}
                            <form class="meta-edit-form" style="display:none; margin-top: 1rem; border-top: 1px solid var(--border-color, #ddd); padding-top: 1rem;"
                                  method="POST" action="/docs/id/{{.Document.ID}}/metadata"
                                  hx-post="/docs/id/{{.Document.ID}}/metadata" hx-swap="none">
                                {{$.CSRFField}}
                                <div class="form-group" style="margin-bottom: 0.75rem;">
                                    <label for="meta_doc_type" style="font-size: 0.85rem;">Type</label>
                                    <select id="meta_doc_type" name="doc_type" class="form-control" style="font-size: 0.85rem;">
                                        <option value="doc" {{if eq .Document.DocType "doc"}}selected{{end}}>Doc</option>
                                        <option value="runbook" {{if eq .Document.DocType "runbook"}}selected{{end}}>Runbook</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0.75rem;">
                                    <label for="meta_sensitivity" style="font-size: 0.85rem;">Sensitivity</label>
                                    <select id="meta_sensitivity" name="sensitivity" class="form-control" style="font-size: 0.85rem;">
                                        <option value="public-internal" {{if eq .Document.Sensitivity "public-internal"}}selected{{end}}>Public Internal</option>
                                        <option value="restricted" {{if eq .Document.Sensitivity "restricted"}}selected{{end}}>Restricted</option>
                                        <option value="confidential" {{if eq .Document.Sensitivity "confidential"}}selected{{end}}>Confidential</option>
                                    </select>
                                </div>
                                {{if .Users}}
                                <div class="form-group" style="margin-bottom: 0.75rem;">
                                    <label for="meta_owner" style="font-size: 0.85rem;">Owner</label>
                                    <select id="meta_owner" name="owner_user_id" class="form-control" style="font-size: 0.85rem;">
                                        <option value="">-- None --</option>
                                        {{range .Users}}
                                        <option value="{{.ID}}" {{if .Selected}}selected{{end}}>{{.Name}}</option>
                                        {{end}}
                                    </select>
                                </div>
                                {{end}}
                                {{if .ClientOptions}}
                                <div class="form-group" style="margin-bottom: 0.75rem;">
                                    <label for="meta_client" style="font-size: 0.85rem;">Client</label>
                                    <select id="meta_client" name="client_id" class="form-control" style="font-size: 0.85rem;">
                                        <option value="">-- None --</option>
                                        {{range .ClientOptions}}
                                        <option value="{{.ID}}" {{if .Selected}}selected{{end}}>{{.Name}}</option>
                                        {{end}}
                                    </select>
                                </div>
                                {{end}}
                                <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
                            </form>
                            {{end}}
                        </div>
                    </aside>
                </div>

            </div>
        </main>
    </div>
{{template "page_scripts" .}}
</body>
</html>
{{end}}
