{{define "instance_view.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {{template "head_common" .}}
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>
</head>
<body>
    <div class="app-container">
        {{template "sidebar" .}}
        <main class="main-content">
            {{template "topbar" .}}
            <div class="content">
                {{template "alerts" .}}

                {{$inst := .Content}}

                <nav class="breadcrumbs">
                    <a href="/checklists">Checklists</a>
                    <span class="separator">/</span>
                    <a href="/checklist-instances">Runs</a>
                    <span class="separator">/</span>
                    {{if $inst.Checklist}}{{$inst.Checklist.Name}}{{else}}Run{{end}}
                </nav>

                <div class="page-header">
                    <div class="page-header-row">
                        <h2>
                            {{if $inst.Checklist}}{{$inst.Checklist.Name}}{{else}}Checklist Run{{end}}
                            {{if eq $inst.Status "completed"}}
                            <span class="badge badge-success">Completed</span>
                            {{else}}
                            <span class="badge badge-warning">In Progress</span>
                            {{end}}
                        </h2>
                        <div class="page-header-actions">
                            {{if $.Membership.IsEditor}}
                            <form method="POST" action="/checklist-instances/{{$inst.ID}}/delete" style="display:inline;">
                                {{$.CSRFField}}
                                <button type="submit" class="btn btn-danger btn-sm"
                                        data-confirm="This will permanently delete this checklist run."
                                        data-confirm-title="Delete Run?">Delete</button>
                            </form>
                            {{end}}
                        </div>
                    </div>
                </div>

                <div class="doc-meta">
                    <span>Started by <strong>{{if $inst.Author}}{{$inst.Author.Name}}{{end}}</strong></span>
                    <span>{{timeTag $inst.CreatedAt "Jan 2, 2006 3:04 PM"}}</span>
                    <span>Progress: <strong>{{$inst.CompletedCount}}/{{$inst.TotalCount}}</strong></span>
                    {{if and $inst.LinkedType $inst.LinkedID}}
                    <span>Linked to: <a href="/docs/id/{{$inst.LinkedID}}/edit">{{if $inst.LinkedTitle}}{{$inst.LinkedTitle}}{{else}}Document{{end}}</a></span>
                    {{end}}
                </div>

                <div class="card" id="checklist-items">
                    {{template "instance_items_partial.html" .}}
                </div>

            </div>
        </main>
    </div>
{{template "page_scripts" .}}
</body>
</html>
{{end}}

{{define "instance_items_partial.html"}}
{{$inst := .Content}}
<div class="checklist-progress">
    <div class="progress-bar">
        <div class="progress-bar-fill" style="width: {{if $inst.TotalCount}}{{printf "%.0f" (divf (mulf (tof $inst.CompletedCount) 100.0) (tof $inst.TotalCount))}}%{{else}}0%{{end}}"></div>
    </div>
    <span class="progress-text">{{$inst.CompletedCount}} of {{$inst.TotalCount}} items completed</span>
</div>

<ul class="checklist-items">
    {{range $inst.Items}}
    <li class="checklist-item {{if .Done}}checklist-item-done{{end}}">
        {{if $.Membership.IsEditor}}
        <form method="POST" action="/checklist-instances/{{$inst.ID}}/items/{{.ItemID}}/toggle"
              hx-post="/checklist-instances/{{$inst.ID}}/items/{{.ItemID}}/toggle"
              hx-target="#checklist-items"
              hx-swap="innerHTML">
            {{$.CSRFField}}
            <button type="submit" class="checklist-toggle" aria-label="Toggle item">
                {{if .Done}}☑{{else}}☐{{end}}
            </button>
        </form>
        {{else}}
        <span class="checklist-toggle">{{if .Done}}☑{{else}}☐{{end}}</span>
        {{end}}
        <span class="checklist-item-text">{{.Text}}</span>
        {{if .Done}}
        <span class="checklist-item-meta">
            {{if .DoneBy}}{{.DoneBy.Name}}{{end}}
            {{if .DoneAt}}{{timeTag (deref .DoneAt) "Jan 2 3:04 PM"}}{{end}}
        </span>
        {{end}}
    </li>
    {{end}}
</ul>
{{end}}
